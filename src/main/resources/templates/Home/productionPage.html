<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Production UI</title>
    <link href="/assets/plugins/simplebar/css/simplebar.css" rel="stylesheet"/>
    <link href="/assets/plugins/perfect-scrollbar/css/perfect-scrollbar.css" rel="stylesheet"/>
    <link href="/assets/plugins/metismenu/css/metisMenu.min.css" rel="stylesheet"/>
    <link href="/assets/plugins/datatable/css/dataTables.bootstrap5.min.css" rel="stylesheet"/>
    <!-- loader-->
    <!--    <link href="/assets/css/pace.min.css" rel="stylesheet"/>-->
    <!--    <script src="/assets/js/pace.min.js"></script>-->
    <!-- Bootstrap CSS -->
    <link href="/assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/css/bootstrap-extended.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link href="/assets/css/app.css" rel="stylesheet">
    <link href="/assets/css/icons.css" rel="stylesheet">

    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
            crossorigin="anonymous"
    />
    <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"
    ></script>
    <link
            th:href="@{/assets/plugins/datatable/css/dataTables.bootstrap5.min.css}"
            rel="stylesheet"
    />
    <!-- Include Font Awesome CSS -->
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
</head>

<style>
    .status-button {
        border: none;
        color: #000000;
        padding: 5px 10px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
        margin: 4px 2px;
        cursor: pointer;
    }

    #console {
        width: 100%;
        height: 90vh;
        overflow-y: auto;
        padding: 10px;
        border: 1px solid lime;
    }

    .status-green {
        background-color: green;
    }

    .status-red {
        background-color: red;
    }

    /*body {*/
    /*    font-family: Arial, sans-serif;*/
    /*    background-color: #f8f9fa;*/
    /*}*/

    h1 {
        color: #343a40;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    .table {
        background-color: #ffffff;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .table thead th {
        background-color: #343a40;
        color: #ffffff;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .table tbody tr:hover {
        background-color: #f1f1f1;
    }

    .table td,
    .table th {
        vertical-align: middle;
        padding: 12px;
    }

    .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
    }

    .btn-primary:hover {
        background-color: #0056b3;
        border-color: #0056b3;
    }

    .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background-color: #8eb9b9;
        padding: 20px 40px; /* Increased padding for more height and width */
        height: 100px; /* Increased height */
    }

    /* Styling for the image */
    .header img {
        height: 70px; /* Adjusted height of the image */
    }

    /* Styling for the center title */
    .header h1 {
        margin: 0;
        font-size: 28px; /* Increased font size */
        flex-grow: 1;
        text-align: center;
    }
</style>
<body>

<header class="header m-1">
    <!-- Image on the left -->
    <img src="/assets/GC Cloud Logo.png" alt="Logo">

    <!-- Centered text -->
    <h1 style="
        display: flex;
        justify-content: center;
        font-weight: 700;
        font-family: fangsong;

      ">Web Production Portal</h1>
</header>

<!--<div class="card">-->
<!--    <div class="card-body">-->
<!--        <div class="table-responsive">-->
<!--            <table id="example2" class="table table-striped table-bordered">-->
<div class="container-fluid">

    <div class="row text-center justify-content-center">
        <!---------Sql Backup Button------------->
        <div class="col-xl-4 col-lg-3 col-md-12 col-sm-12 col-12">
            <h1 class="mb-4">SQL/File Backup</h1>
            <a th:href="@{/jar/uploadDownlaodForm}" class="btn btn-primary btn-lg">
                SQL/File Backup
            </a>
        </div>

        <!---------Add Backup Button------------->
        <div class="col-xl-4 col-lg-3 col-md-12 col-sm-12 col-12">

            <h1 class="mb-4">Killer Dns Manger</h1>
            <a th:href="@{/jar/goDaddyPage}" class="btn btn-danger btn-lg">
                Killer Dns Manger
            </a>
        </div>

        <!---------Add Jar Upload  Button------------->
        <div class="col-xl-4 col-lg-3 col-md-12 col-sm-12 col-12">

            <h1 class="mb-4">Upload Jar </h1>
            <a th:href="@{/jar/jarForm}" class="btn btn-warning btn-lg">
                Upload Jar
            </a>
        </div>

    </div>
    <!-------------------------------------STARTED TABLE AFTER BUTTONS SQL/FILE BACKUP  & KILLER DNS MANGER   & UPLOAD JAR--------------------------------------------->

    <div class="table-responsive mt-5">
        <table
                id="productionTable"
                class="table table-striped table-bordered"
                style="width: 100%"
        >
            <thead class="text-center">
            <tr>
                <th scope="col">Sr.</th>
                <th scope="col" >Hidden Id</th>
                <th scope="col">JAR</th>
                <th scope="col">Website</th>
                <th scope="col">Port</th>
                <th scope="col">Domain</th>
                <th scope="col">SSL Status</th>
                <th scope="col">Running Status</th>
                <th scope="col">TP Link</th>
                <th scope="col">Domain Link</th>
                <th scope="col">Action</th>
            </tr>
            </thead>
            <tbody class="text-center">
            <tr th:each="user, x : ${userList}">
                <td th:text="${x.index + 1}"></td>
                <td  th:text="${user.id}"></td>
                <td th:text="${user.jarFilePath}"></td>
                <td th:text="${user.website}"></td>
                <td th:text="${user.port}"></td>
                <td th:text="${user.domain}"></td>
                <td>SSL Status</td>
                <td>
                    <button class="status-button" id="status-${user.id}"
                            th:onclick="checkStatus([[${user.port}]],this)">
                        Check Status
                    </button>
                </td>
                <td>TP Status</td>
                <td th:text="${user.domainLink}"></td>
                <td class="d-flex justify-content-around">
                    <div class="d-flex order-actions justify-content-center align-items-center">
                        <a class="ms-3" th:onclick="performAction([[${user.jarFilePath}]],[[${user.id}]])">
                            <i class="fas fa-play"></i>
                        </a>
                        <a class="ms-3 btn btn-dark" data-bs-toggle="modal" data-bs-target="#exampleDarkModal"
                           th:onclick="fetchIdWiseData([[${user.id}]])">
                            <i class="fas fa-upload"></i>
                        </a>
                        <a class="ms-3" th:onclick="killingJar([[${user.jarFilePath}]],[[${user.id}]])">
                            <i class="fas fa-stop"></i>
                        </a>
                        <!--                            <a class="ms-3">-->
                        <!--                                <i class="fa-brands fa-neos"></i>-->
                        <!--                            </a>-->
                    </div>
                </td>
            </tr>
            </tbody>
        </table>

    </div>

    <!-------------------------------------ENDED TABLE AFTER BUTTONS SQL/FILE BACKUP  & KILLER DNS MANGER   & UPLOAD JAR--------------------------------------------->

    <h1 class="text-center">Real-Time CMD Console</h1>
    <!--    <div id="console"></div>-->
    <div class="container mt-4">
        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs" id="jarTabs" role="tablist"></ul>

        <!-- Tabs Content -->
        <div class="tab-content" id="jarTabsContent"></div>
    </div>


</div>
<div class="col">
    <!-- Button trigger modal -->

    <!-- -------------------------------------START MODAL TO REPLACE THE JAR-------------------------------------------------------->

    <div class="modal fade" id="exampleDarkModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title text-white">Modal title</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-white">


                    <form id="uploadFileTobucket">
                        <div class="card">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Jar File:</label>
                                    <div class="input-group">
                                        <input type="file" id="jarFileExp" name="jarFile" class="form-control" accept=".jar" required>
                                        <button type="button" id="uploadButton" class="btn btn-primary">Upload</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </form>


<!--                    <form th:action="@{/jar/updateJar}" method="post" novalidate enctype="multipart/form-data">-->
<!--                        <div class="card">-->
<!--                            <div class="card-body">-->

<!--                                <div class="mb-3">-->
<!--                                    <label class="form-label">ID</label>-->
<!--                                    <input type="text" id="id" name="id" class="form-control">-->
<!--                                </div>-->
<!--                                <div class="mb-3">-->
<!--                                    <label class="form-label">Jar File:</label>-->
<!--                                    <input type="file" name="jarFile" class="form-control">-->
<!--                                </div>-->
<!--                                <div class="mb-3">-->
<!--                                    <label class="form-label">Uplaoding Developer Name:</label>-->
<!--                                    <input type="text" id="developerName" name="developerName" class="form-control">-->
<!--                                </div>-->


<!--                                <div class="mb-3">-->
<!--                                    <label class="form-label">Website Name:</label>-->
<!--                                    <input type="text" id="website" name="website" class="form-control"-->
<!--                                           placeholder="Website Nam">-->
<!--                                </div>-->

<!--                                <div class="mb-3">-->
<!--                                    <label class="form-label">Domain Name:</label>-->
<!--                                    <input type="text" id="domain" name="domain" class="form-control"-->
<!--                                           placeholder="Domain Name">-->
<!--                                </div>-->
<!--                                <div class="mb-3">-->
<!--                                    <label class="form-label">Port:</label>-->
<!--                                    <input type="text" id="port" name="port" class="form-control" placeholder="Port">-->
<!--                                </div>-->
<!--                                <div class="mb-3">-->
<!--                                    <label class="form-label">Url:</label>-->
<!--                                    <input type="url" id="url" name="url" class="form-control"-->
<!--                                           placeholder="https://example.com/users/">-->
<!--                                </div>-->

<!--                                <div class="mb-3">-->
<!--                                    <label class="form-label">Date:</label>-->
<!--                                    <input type="date" id="date" name="date" class="form-control">-->
<!--                                </div>-->
<!--                                <div class="mb-3">-->
<!--                                    <label class="form-label">Month:</label>-->
<!--                                    <input type="month" id="month" name="month" class="form-control">-->
<!--                                </div>-->


<!--                                <div class="mb-3">-->
<!--                                    <label class="form-label">Time:</label>-->
<!--                                    <input type="time" id="time" name="time" class="form-control">-->
<!--                                </div>-->


<!--                            </div>-->
<!--                        </div>-->

<!--                        <div class="text-center"> &lt;!&ndash; or use d-flex justify-content-center &ndash;&gt;-->
<!--                            <button type="submit" class="btn btn-primary">Upload</button>-->
<!--                        </div>-->
<!--                    </form>-->

                    <form id="updateForm">
                        <div class="card">
                            <div class="card-body">

                                <div class="mb-3">
                                    <label class="form-label">ID</label>
                                    <input type="text" id="id" name="id" class="form-control">
                                </div>
                                <!------------------------------Enter Jar File Name----------------------------->
                                <div class="mb-3">
                                    <label class="form-label">Enter Jar File Name (e.j monitor.jar,jalshakti.jar):</label>
                                    <input type="text" id="jarFileName" name="originalFileName" class="form-control" required>
                                </div>
                                <!------------------------------Developer Name----------------------------->
                                <div class="mb-3">
                                    <label class="form-label">Uploading Developer Name:</label>
                                    <input type="text" id="developerName" name="developerName" class="form-control" required>
                                </div>
                                <!------------------------------Developer Name----------------------------->

                                <div class="mb-3">
                                    <label class="form-label">Website Name:</label>
                                    <input type="text" id="website" name="website" class="form-control" placeholder="Website Name"
                                           required>
                                </div>
                                <!------------------------------Developer Name----------------------------->

                                <div class="mb-3">
                                    <label class="form-label">Domain Name:</label>
                                    <input type="text" id="domain" name="domain" class="form-control" placeholder="Domain Name"
                                           required>
                                </div>
                                <!------------------------------Specified Port----------------------------->

                                <div class="mb-3">
                                    <label class="form-label">Port:</label>
                                    <input type="text" id="port" name="port" class="form-control" placeholder="Port" required>
                                </div>
                                <!------------------------------Developer Name----------------------------->

                                <div class="mb-3">
                                    <label class="form-label">Url:</label>
                                    <input type="url" id="url" name="url" class="form-control" placeholder="https://example.com/users/"
                                           required>
                                </div>
                                <!------------------------------Date ----------------------------->

                                <div class="mb-3">
                                    <label class="form-label">Date:</label>
                                    <input type="date" id="date" name="date" class="form-control" required>
                                </div>
                                <!------------------------------Month ----------------------------->

                                <div class="mb-3">
                                    <label class="form-label">Month:</label>
                                    <input type="month" id="month" name="month" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Time:</label>
                                    <input type="time" id="time" name="time" class="form-control" required>
                                </div>
                            </div>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary">Update</button>
                        </div>
                    </form>
                    <div id="status"></div>

                </div>
            </div>
        </div>
    </div>

    <!-- -------------------------------------ENDED MODAL TO REPLACE THE JAR-------------------------------------------------------->

</div>


<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"
></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/reconnecting-websocket/dist/reconnecting-websocket.min.js"></script>

<script src="/static/reconnecting-websocket.js"></script>

<script>
    $(document).ready(function () {
        var table = $("#productionTable").DataTable({
            dom:
                '<"top row px-3 py-1 border border-2 border-grey bg-gradient-primary "' +
                // '   <"col-lg-2 col-md-2 col-sm-12 p-1 d-flex align-items-center"l>' +
                '   <"col-lg-6 col-md-6 col-sm-12 p-1 d-flex align-items-center"B>' +
                '   <"col-lg-6 col-md-6 col-sm-12 p-1 d-flex align-items-center"f>' +
                '   <"clear">>rt' +
                '<"bottom row px-5"' +
                '  <"col-lg-6 col-md-6 col-sm-12"i>' +
                '  <"col-lg-6 col-md-6 col-sm-12"p>' +
                '   <"clear">>',
            paging: false,
            scrollX: true,

            lengthChange: false,
            buttons: ["copy", "excel", "pdf", "print"],
            initComplete: function () {
                $(".dt-buttons button").removeClass("btn-light");
                $(".dt-buttons button").addClass("m-0 btn-sm btn-outline-dark");
                $(".dataTables_filter").addClass("w-100 text-center d-flex");
                $(".dataTables_filter input").addClass("w-75 border-2 border-info ");
                $(".dataTables_filter label").addClass(
                    "w-100 text-center align-items-center justify-content-around d-flex m-0 text-dark font-weight-bold"
                );
                $(".dt-buttons.btn-group").css("width", "-webkit-fill-available");
                // $('.dataTables_scrollHead').css('overflow','auto');
                // $('.dataTables_scrollBody').css('overflow','auto');

                // Add extra classes to the DataTable container
                // $('#drainStatus_wrapper').addClass('mb-15');
                // $('#drainStatus_wrapper').children(0).css('border-radius', '30px');

                // var scrollHead = document.getElementsByClassName('dataTables_scrollHead')[0];
                // var scrollBody = document.getElementsByClassName('dataTables_scrollBody')[0];
                //
                // // Add a scroll event listener to the scroll body
                // scrollHead.addEventListener('scroll', function () {
                //   // Update the scrollLeft of the scroll head to match the scrollLeft of the scroll body
                //   scrollBody.scrollLeft = scrollHead.scrollLeft;
                // });
            },
        });

        table
            .buttons()
            .container()
            .appendTo("#productionTable_wrapper .col-md-6:eq(0)");
    });
</script>

<script>
    function parallax_height() {
        var scroll_top = $(this).scrollTop();
        var sample_section_top = $(".sample-section").offset().top;
        var header_height = $(".sample-header-section").outerHeight();
        $(".sample-section").css({"margin-top": header_height});
        $(".sample-header").css({height: header_height - scroll_top});
    }

    parallax_height();
    $(window).scroll(function () {
        parallax_height();
    });
    $(window).resize(function () {
        parallax_height();
    });
</script>

<!--This contains script for sending bucket file  And Uplaod Form-->
<script src="/Js/bucketUploadScript.js"></script>

<!---------------------Script For CMD Logics  Started------------------------->
<script>


    let tabCounter = 1; // Counter for dynamically created CMD tabs
    let activeSessions = []; // Track active sessions to persist across refresh

    // Function to Perform Action on Play Button Click sab kch yhni se shuur horha h
    function performAction(path, id) {
        console.log("JAR Path:", path, "Row Data:", id);

        // Generate IDs
        const sessionId = `cmd-${id}`;
        const tabId = `tab-${tabCounter}`;
        const paneId = `pane-${tabCounter}`;
        const consoleId = `console-${paneId}`;

        // Avoid duplicate sessions
        // if (!activeSessions.includes(sessionId)) {
        //     activeSessions.push(sessionId);
        //     sessionStorage.setItem('activeSessions', JSON.stringify(activeSessions));
        // }
        // Avoid duplicate sessions
        if (!activeSessions.includes(sessionId)) {
            activeSessions.push(sessionId);
            sessionStorage.setItem('activeSessions', JSON.stringify(activeSessions));
            // Persist session in Redis
            fetch(`/data/saveSession?sessionId=${sessionId}`, {method: 'POST'})
                .then(response => response.text())
                .then(data => console.log("Session saved in Redis:", data))
                .catch(error => console.error("Error saving session in Redis:", error));
        }

        tabCounter++;

        // Create CMD Tab and WebSocket
        createCMDTab(tabId, paneId, consoleId, sessionId);
        setupWebSocket(path, id, sessionId, consoleId);
    }

    // Function to Create CMD Tabs Dynamically
    function createCMDTab(tabId, paneId, consoleId, sessionId) {
        // Add a new tab with a close button
        const tabHTML = `
        <li class="nav-item" id="tab-container-${tabId}">
            <button class="nav-link d-flex justify-content-between align-items-center" id="${tabId}"
                    data-bs-toggle="tab" data-bs-target="#${paneId}" type="button" role="tab" aria-controls="${paneId}">
                CMD ${tabCounter - 1}
                <span onclick="closeTab('${tabId}', '${paneId}', '${sessionId}', '${consoleId}')"
                      style="margin-left: 10px; cursor: pointer; color: red;">&times;</span>
            </button>
        </li>`;

        // Add a new pane for CMD Console
        const paneHTML = `
        <div class="tab-pane fade" id="${paneId}" role="tabpanel" aria-labelledby="${tabId}">
            <div id="${consoleId}" class="border p-3" style="height: 300px; overflow-y: auto; background-color: #000; color: #00FF00;">
                <span style="color: lime">WebSocket Connection Establishing...</span><br>
            </div>
        </div>`;

        // Append to DOM
        document.getElementById('jarTabs').insertAdjacentHTML('beforeend', tabHTML);
        document.getElementById('jarTabsContent').insertAdjacentHTML('beforeend', paneHTML);

        // Activate the new tab
        document.getElementById(tabId).click();
    }

    // 😎 This is new Approach lets see this approach and work on this (It worked!😎)
    window.onload = function reloadSessions() {

        // Fetch active sessions from Redis
        fetch('/data/fetchActiveSessions')
            .then(response => response.json())
            .then(savedSessions => {
                savedSessions.forEach(sessionId => {
                    const tabId = `tab-${tabCounter}`;
                    const paneId = `pane-${tabCounter}`;
                    const consoleId = `console-${paneId}`;
                    tabCounter++;

                    // Recreate CMD Tab
                    createCMDTab(tabId, paneId, consoleId, sessionId);

                    // Fetch persisted logs (directly calling it from redis)
                    fetch(`/data/fetchLogs?sessionId=${sessionId}`)
                        .then(response => response.json())
                        .then(logs => {
                            const consoleDiv = document.getElementById(consoleId);
                            logs.forEach(log => {
                                consoleDiv.innerHTML += log + '<br>';
                            });
                            consoleDiv.scrollTop = consoleDiv.scrollHeight; // Auto-scroll
                        })
                        .catch(error => console.error("Error fetching logs:", error));

                    // Reconnect WebSocket for live updates (sabse mast logic h ye ❣️)
                    justToReconnectWebsocket(sessionId, consoleId);
                });
            })
            .catch(error => console.error('Error fetching active sessions:', error));
    };

    function justToReconnectWebsocket(sessionId, consoleId) {

        const consoleDiv = document.getElementById(consoleId);
        // const socket = new WebSocket(`ws://localhost:5050/ws/logs?sessionId=${sessionId}`);
        const socket = new WebSocket(`wss://jar-status-portal-1046319252567.asia-south2.run.app/ws/logs?sessionId=${sessionId}`);
        // console.log("reconnecting link ", socket)


        // const wsUrl = `ws://localhost:5050/ws/logs?sessionId=${sessionId}`;
        // const socket = new ReconnectingWebSocket(wsUrl, null, {
        //     debug: true,
        //     reconnectInterval: 3000,
        //     maxReconnectInterval: 30000,
        //     reconnectDecay: 1.5,
        //     timeoutInterval: 5000,
        //     maxReconnectAttempts: null
        // });


        socket.onopen = () => {
            consoleDiv.innerHTML += '<span style="color: lime">WebSocket Connection Established</span><br>';
        };

        socket.onmessage = (event) => {
            console.log(event.data)
            if (event.data === "ping") {
                socket.send("pong");
                console.log("Pong sent in response to ping.");
            } else {
                consoleDiv.innerHTML += event.data + '<br>';
                consoleDiv.scrollTop = consoleDiv.scrollHeight; // Auto-scroll to the bottom
            }

        };

        socket.onerror = () => {
            consoleDiv.innerHTML += '<span style="color: red">WebSocket Error!</span><br>';
        };

        socket.onclose = () => {
            consoleDiv.innerHTML += '<span style="color: orange">WebSocket Connection Closed. Retrying...</span><br>';
            setTimeout(() => justToReconnectWebsocket(sessionId, consoleId), 5000); // Retry after 5 seconds
        };

        consoleDiv.socket = socket; // Attach socket for cleanup

    }

    // Function to Setup WebSocket
    function setupWebSocket(path, id, sessionId, consoleId) {
         ;
        console.log("redis SessionId", sessionId)
        console.log("redis consoleId", consoleId)
        const consoleDiv = document.getElementById(consoleId);
        // const socket = new WebSocket(`ws://localhost:5050/ws/logs?sessionId=${sessionId}`);
        const socket = new WebSocket(`wss://jar-status-portal-1046319252567.asia-south2.run.app/ws/logs?sessionId=${sessionId}`);


        // New Logic Of websocket Connection----
        // WebSocket URL
        // const wsUrl = `wss://jar-status-portal-1046319252567.asia-south2.run.app/ws/logs?sessionId=${sessionId}`;
        //
        // // Use ReconnectingWebSocket
        // const socket = new ReconnectingWebSocket(wsUrl, null, {
        //     debug: true, // Enable debug logs for development
        //     reconnectInterval: 3000, // Retry every 3 seconds
        //     maxReconnectInterval: 30000, // Max delay between retries
        //     reconnectDecay: 1.5, // Increase delay by 1.5x on each retry
        //     timeoutInterval: 5000, // Time to wait before assuming the connection has failed
        //     maxReconnectAttempts: null // Retry indefinitely
        // });


        console.log("setup websocket link ", socket)
        socket.onopen = () => {
            consoleDiv.innerHTML += '<span style="color: lime">WebSocket Connection Established</span><br>';
        };

        socket.onmessage = (event) => {
            const message = event.data;
            if (event.data === "ping") {
                socket.send("pong");
                console.log("Pong sent in response to ping.");
            } else {
                console.log("Message received:", event.data);
            }

            console.log(event.data)
            consoleDiv.innerHTML += event.data + '<br>';
            consoleDiv.scrollTop = consoleDiv.scrollHeight; // Auto-scroll to the bottom
        };

        socket.onerror = () => {
            consoleDiv.innerHTML += '<span style="color: red">WebSocket Error!</span><br>';
        };

        socket.onclose = () => {
            consoleDiv.innerHTML += '<span style="color: orange">WebSocket Connection Closed</span><br>';
        };

        consoleDiv.socket = socket; // Attach socket for cleanup


        // If triggered by play button, call the backend to execute JAR
        if (path && id) {
            fetch(`/data/executeJar?jarPath=${encodeURIComponent(path)}&sessionId=${sessionId}&id=${id}`, {
                method: 'POST'
            })
                .then(response => response.text())
                .then(data => console.log("Backend Response:", data))
                .catch(error => console.error("Error:", error));
        }
    }

    // Function to Close Tab and Cleanup
    function closeTab(tabId, paneId, sessionId, consoleId) {
        // Remove Tab and Pane
        document.getElementById(`tab-container-${tabId}`).remove();
        document.getElementById(paneId).remove();

        // Terminate WebSocket
        const consoleDiv = document.getElementById(consoleId);
        if (consoleDiv && consoleDiv.socket) {
            consoleDiv.socket.close();
            console.log("WebSocket Closed for Session:", sessionId);
        }

        // Remove sessionId from activeSessions (this session logic was pre build so it been optimized if you want to remove this session part you can !)
        activeSessions = activeSessions.filter(s => s !== sessionId);
        sessionStorage.setItem('activeSessions', JSON.stringify(activeSessions));
        // Remove sessionId from Redis ❣️
        fetch(`/data/removeSession?sessionId=${sessionId}`, {method: 'DELETE'})
            .then(response => response.text())
            .then(data => console.log("Session removed from Redis:", data))
            .catch(error => console.error("Error removing session from Redis:", error));
    }

    // Function to Kill JAR
    function killingJar(jarPath, id) {
        fetch(`/data/killJar?id=${id}`, {method: 'POST'})
            .then(response => response.text())
            .then(data => {
                console.log(data);
                alert("Process Killed Successfully!");
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Failed to kill the process.");
            });
    }

    // It's not been functional yet
    function checkStatus(port, buttonElement) {
        fetch(`http://localhost:${port}/actuator/health`)
            .then(response => response.json())
            .then(data => {
                // Assuming health check response includes a status field
                if (data.status === 'UP') {
                    buttonElement.classList.add('status-green');
                    buttonElement.classList.remove('status-red');
                    buttonElement.textContent = 'UP';
                } else {
                    buttonElement.classList.add('status-red');
                    buttonElement.classList.remove('status-green');
                    buttonElement.textContent = 'DOWN';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                buttonElement.classList.add('status-red');
                buttonElement.classList.remove('status-green');
                buttonElement.textContent = 'DOWN';
            });
    }


</script>
<!---------------------Script For CMD Logics  Ended------------------------->


<script>
    document.getElementById("updateForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        console.log('universalFilePath',universalFilePath)
        await commonBucketFun();

    });
</script>


</body>
</html>
